<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Chat Widget</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #131313 0%, #f5f3f7 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Particle Background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: particleFloat 15s infinite ease-in-out;
        }

        @keyframes particleFloat {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(50px);
                opacity: 0;
            }
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            animation: badgePulse 2s ease-in-out infinite;
            z-index: 1001;
        }

        @keyframes badgePulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        /* Floating Chat Button */
        .chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #fafbfc 0%, #0f0f0f 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(98, 99, 101, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
            animation: float 3s ease-in-out infinite, pulse 2s ease-in-out infinite;
            border: none;
            outline: none;
        }

        .chat-button:hover, .chat-button:focus {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .chat-button.active {
            transform: scale(0.9);
        }

        .chat-icon {
            width: 35px;
            height: 35px;
            fill: white;
            transition: transform 0.3s ease;
        }

        .chat-button:hover .chat-icon, .chat-button:focus .chat-icon {
            transform: scale(1.1) rotate(10deg);
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            width: 100%;
            height: 100%;
            animation: rippleEffect 0.6s ease-out;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            bottom: 35px;
            right: 110px;
            background: white;
            color: #333;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 999;
            animation: tooltipFloat 3s ease-in-out infinite;
        }

        .tooltip.show {
            opacity: 1;
            transform: translateX(0);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid white;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        /* Chat Interface */
        .chat-interface {
            position: fixed;
            bottom: 120px;
            right: 30px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: scale(0.8) translateY(20px);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: none;
            z-index: 998;
            overflow: hidden;
        }

        .chat-interface.open {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: all;
        }

        /* Chat Header */
        .chat-header {
            background: linear-gradient(135deg, #eeeff4 0%, #10100f 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 20px 20px 0 0;
            position: relative;
            overflow: hidden;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: headerShine 3s ease-in-out infinite;
        }

        @keyframes headerShine {
            0%, 100% {
                transform: translate(0, 0);
            }
            50% {
                transform: translate(-20%, -20%);
            }
        }

        .chat-header-content {
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1;
        }

        .bot-avatar {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            animation: avatarBounce 2s ease-in-out infinite;
        }

        @keyframes avatarBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        .bot-avatar svg {
            width: 28px;
            height: 28px;
            fill: #667eea;
        }

        .chat-header-text {
            z-index: 1;
        }

        .chat-header-text h3 {
            font-size: 18px;
            margin-bottom: 3px;
        }

        .chat-header-text p {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .online-status {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: statusPulse 2s ease-in-out infinite;
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
        }

        @keyframes statusPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(74, 222, 128, 0);
            }
        }

        .header-actions {
            display: flex;
            gap: 8px;
            z-index: 1;
        }

        .minimize-button, .close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .minimize-button:hover, .close-button:hover,
        .minimize-button:focus, .close-button:focus {
            background: rgba(255, 255, 255, 0.3);
        }

        .close-button:hover, .close-button:focus {
            transform: rotate(90deg);
        }

        /* Chat Body */
        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(to bottom, #f9fafb 0%, #ffffff 100%);
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .chat-body::-webkit-scrollbar {
            width: 6px;
        }

        .chat-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .chat-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Welcome Message */
        .welcome-section {
            text-align: center;
            padding: 40px 20px;
            animation: fadeInUp 0.6s ease;
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #454649 0%, #f1edf4 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            animation: welcomePulse 2s ease-in-out infinite;
        }

        .welcome-icon svg {
            width: 40px;
            height: 40px;
            fill: white;
        }

        @keyframes welcomePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(102, 126, 234, 0);
            }
        }

        .welcome-section h2 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .welcome-section p {
            color: #64748b;
            margin-bottom: 30px;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #252525 0%, #ece9ef 100%);
        }

        .message.user .message-avatar {
            background: #e2e8f0;
            color: #475569;
            font-weight: 600;
            font-size: 14px;
        }

        .message-avatar svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #fbf9f9 0%, #131313 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-content {
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 5px;
            text-align: right;
        }

        .message.user .message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Image Message */
        .message-image {
            max-width: 200px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .message-image:hover {
            transform: scale(1.05);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            width: fit-content;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Quick Replies */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-reply {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 6px;
            border: none;
            outline: none;
        }

        .quick-reply:hover, .quick-reply:focus {
            border-color: #667eea;
            background: linear-gradient(135deg, #062dda 0%, #161617 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Speak to Agent Button - Made smaller */
        .agent-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 10px auto;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            outline: none;
            width: auto;
            max-width: 180px;
        }

        .agent-button:hover, .agent-button:focus {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }

        .agent-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .agent-button svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        /* End Chat Button */
        .end-chat-button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 10px auto;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            outline: none;
            width: auto;
            max-width: 180px;
        }

        .end-chat-button:hover, .end-chat-button:focus {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
        }

        /* Agent Status */
        .agent-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .agent-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #94a3b8;
        }

        .agent-dot.online {
            background: #10b981;
            animation: statusPulse 2s ease-in-out infinite;
        }

        .agent-dot.offline {
            background: #ef4444;
        }

        /* Agent Connection */
        .agent-connection {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }

        .agent-connection h4 {
            color: #065f46;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .agent-connection p {
            color: #047857;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .agent-info {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .agent-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .agent-name {
            font-weight: 600;
            color: #065f46;
        }

        /* Suggested Actions */
        .suggested-actions {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .suggested-actions-title {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .action-button {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #475569;
            border: none;
            outline: none;
        }

        .action-button:hover, .action-button:focus {
            background: #f1f5f9;
            border-color: #66ea7a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .action-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #062fea 0%, #0b0b0b 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .action-icon svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        /* Chat Footer */
        .chat-footer {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
            position: relative;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            position: relative;
        }

        .attachment-button {
            width: 40px;
            height: 40px;
            background: #f1f5f9;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            outline: none;
        }

        .attachment-button:hover, .attachment-button:focus {
            background: #e2e8f0;
            transform: rotate(90deg);
        }

        .attachment-button svg {
            width: 20px;
            height: 20px;
            fill: #64748b;
        }

        .chat-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #020c39;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-button {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #062fe8 0%, #0f0f10 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
            outline: none;
        }

        .send-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .send-button:hover::before, .send-button:focus::before {
            width: 100px;
            height: 100px;
        }

        .send-button:hover, .send-button:focus {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            fill: white;
            position: relative;
            z-index: 1;
        }

        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: -50px;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: none;
            outline: none;
        }

        .sound-toggle:hover, .sound-toggle:focus {
            background: #f8fafc;
        }

        .sound-icon {
            width: 16px;
            height: 16px;
            fill: #667eea;
        }

        /* Registration Form */
        .registration-form {
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.5s ease;
        }

        .form-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1e293b;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #475569;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .form-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .form-button:hover, .form-button:focus {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .form-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .otp-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .otp-digit {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .otp-digit:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .language-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .language-option {
            padding: 12px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
        }

        .language-option:hover, .language-option:focus {
            background: #f1f5f9;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .language-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .form-note {
            font-size: 12px;
            color: #64748b;
            text-align: center;
            margin-top: 10px;
        }

        .resend-otp {
            font-size: 12px;
            color: #667eea;
            text-align: center;
            margin-top: 10px;
            cursor: pointer;
            text-decoration: underline;
        }

        .resend-otp:hover {
            color: #5a67d8;
        }

        .resend-otp:disabled {
            color: #94a3b8;
            cursor: not-allowed;
        }

        .error-message {
            color: #ef4444;
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            color: #10b981;
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        /* Animations */
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
            }
            50% {
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.8), 0 0 0 10px rgba(102, 126, 234, 0.1);
            }
        }

        @keyframes tooltipFloat {
            0%, 100% {
                transform: translateX(0) translateY(0);
            }
            50% {
                transform: translateX(0) translateY(-5px);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Emoji Picker */
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1001;
            animation: fadeInUp 0.3s ease;
        }

        .emoji-picker.show {
            display: block;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .emoji {
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            text-align: center;
            border: none;
            background: transparent;
            outline: none;
        }

        .emoji:hover, .emoji:focus {
            background: #f1f5f9;
            transform: scale(1.2);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .chat-interface {
                width: calc(100vw - 30px);
                right: 15px;
                bottom: 110px;
                height: calc(100vh - 140px);
                max-height: 80vh;
            }

            .chat-button {
                right: 15px;
                bottom: 20px;
                width: 60px;
                height: 60px;
            }

            .chat-icon {
                width: 30px;
                height: 30px;
            }

            .tooltip {
                right: 85px;
                bottom: 25px;
                font-size: 12px;
                padding: 10px 16px;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .message-content {
                max-width: 85%;
            }

            .sound-toggle {
                top: -45px;
                padding: 6px 10px;
                font-size: 11px;
            }

            .emoji-picker {
                width: 90%;
                right: 5%;
                bottom: 65px;
            }

            .emoji-grid {
                grid-template-columns: repeat(5, 1fr);
            }

            .language-selection {
                grid-template-columns: 1fr;
            }

            .otp-digit {
                width: 35px;
                height: 35px;
            }

            .agent-button, .end-chat-button {
                max-width: 160px;
                padding: 8px 14px;
                font-size: 12px;
            }
        }

        @media (max-width: 350px) {
            .chat-interface {
                width: calc(100vw - 20px);
                right: 10px;
            }

            .chat-button {
                right: 10px;
                bottom: 15px;
                width: 55px;
                height: 55px;
            }

            .tooltip {
                right: 75px;
                bottom: 20px;
            }

            .emoji-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .agent-button, .end-chat-button {
                max-width: 140px;
                padding: 7px 12px;
                font-size: 11px;
            }
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Mobile keyboard handling */
        .keyboard-open .chat-interface {
            height: 60vh;
            bottom: 80px;
        }

        /* Focus states for accessibility */
        button:focus-visible, .quick-reply:focus-visible, .action-button:focus-visible {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* Enhanced Chat Features */
        .message-status {
            font-size: 10px;
            margin-top: 2px;
            opacity: 0.7;
        }

        .message-status.sent {
            color: #94a3b8;
        }

        .message-status.delivered {
            color: #10b981;
        }

        .message-status.read {
            color: #3b82f6;
        }

        .chat-metrics {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            font-size: 12px;
        }

        .metric {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .metric-value {
            font-weight: 600;
            color: #667eea;
        }

        .metric-label {
            color: #64748b;
            font-size: 10px;
        }

        .chat-transcript {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .transcript-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: #1e293b;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .transcript-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #64748b;
        }

        .transcript-message {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f1f1f1;
        }

        .transcript-sender {
            font-weight: 600;
            color: #667eea;
        }

        .transcript-time {
            font-size: 10px;
            color: #64748b;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- Particles -->
    <div class="particles" id="particles"></div>

    <!-- Chat Button -->
    <button class="chat-button" id="chatButton" aria-label="Open chat">
        <div class="notification-badge" id="notificationBadge">1</div>
        <svg class="chat-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
            <circle cx="12" cy="10" r="1.5"/>
            <circle cx="8" cy="10" r="1.5"/>
            <circle cx="16" cy="10" r="1.5"/>
        </svg>
    </button>

    <!-- Tooltip -->
    <div class="tooltip show" id="tooltip">
        Need help? Just say Hi üëã
    </div>

    <!-- Chat Interface -->
    <div class="chat-interface" id="chatInterface">
        <!-- Header -->
        <div class="chat-header">
            <div class="chat-header-content">
                <div class="bot-avatar">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                        <circle cx="9" cy="10" r="1.5"/>
                        <circle cx="15" cy="10" r="1.5"/>
                        <path d="M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                    </svg>
                </div>
                <div class="chat-header-text">
                    <h3>Chat Assistant</h3>
                    <p><span class="online-status"></span> Online - Avg. reply time: 1 min</p>
                    <div class="agent-status" id="agentStatus">
                        <span class="agent-dot" id="agentDot"></span>
                        <span id="agentStatusText">Checking agent availability...</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="minimize-button" id="minimizeButton" title="Minimize" aria-label="Minimize chat">‚àí</button>
                <button class="close-button" id="closeButton" title="Close" aria-label="Close chat">√ó</button>
            </div>
        </div>

        <!-- Body -->
        <div class="chat-body" id="chatBody">
            <div class="welcome-section" id="welcomeSection">
                <div class="welcome-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                        <circle cx="9" cy="10" r="1.5"/>
                        <circle cx="15" cy="10" r="1.5"/>
                        <path d="M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                    </svg>
                </div>
                <h2>Welcome! üëã</h2>
                <p>How can we help you today?</p>
            </div>
        </div>

        <!-- Suggested Actions -->
        <div class="suggested-actions" id="suggestedActions">
            <div class="suggested-actions-title">QUICK ACTIONS</div>
            <div class="action-buttons">
                <button class="action-button" data-action="pricing">
                    <div class="action-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 5c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z"/>
                        </svg>
                    </div>
                    View Pricing
                </button>
                <button class="action-button" data-action="support">
                    <div class="action-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/>
                        </svg>
                    </div>
                    Get Support
                </button>
                <button class="action-button" data-action="demo">
                    <div class="action-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                    Watch Demo
                </button>
                <button class="action-button" data-action="contact">
                    <div class="action-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                    </div>
                    Contact Us
                </button>
            </div>
        </div>

        <!-- Chat Footer -->
        <div class="chat-footer">
            <!-- Dynamic Agent Button - Changes between Speak to Agent and End Chat -->
            <button class="agent-button" id="agentActionButton" style="display: none; margin-bottom: 15px;">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                Speak to Agent
            </button>
            
            <div class="sound-toggle" id="soundToggle" role="button" tabindex="0">
                <svg class="sound-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                </svg>
                
            </div>
            <div class="input-container">
                <button class="attachment-button" id="attachmentButton" title="Add attachment" aria-label="Add attachment">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                    </svg>
                </button>
                <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." aria-label="Type your message">
                <button class="send-button" id="sendButton" aria-label="Send message">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Emoji Picker -->
        <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-grid">
                <button class="emoji" data-emoji="üòä">üòä</button>
                <button class="emoji" data-emoji="üòÇ">üòÇ</button>
                <button class="emoji" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
                <button class="emoji" data-emoji="üëç">üëç</button>
                <button class="emoji" data-emoji="üéâ">üéâ</button>
                <button class="emoji" data-emoji="üî•">üî•</button>
                <button class="emoji" data-emoji="‚ú®">‚ú®</button>
                <button class="emoji" data-emoji="üíØ">üíØ</button>
                <button class="emoji" data-emoji="üöÄ">üöÄ</button>
                <button class="emoji" data-emoji="üí°">üí°</button>
                <button class="emoji" data-emoji="‚≠ê">‚≠ê</button>
                <button class="emoji" data-emoji="üéØ">üéØ</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getDatabase, ref, set, get, remove, update, onValue, push } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-functions.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCoJLRqqSsp2uKh6uDDbM_V1e3h7Hd8amY",
            authDomain: "megabot-ceacd.firebaseapp.com",
            projectId: "megabot-ceacd",
            storageBucket: "megabot-ceacd.firebasestorage.app",
            messagingSenderId: "670368037809",
            appId: "1:670368037809:web:d2b1be02dcba4a0240db90",
            measurementId: "G-7JFFJ4YRPZ",
            databaseURL: "https://megabot-ceacd-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);
        const functions = getFunctions(app);

        // DOM Elements
        const chatButton = document.getElementById('chatButton');
        const chatInterface = document.getElementById('chatInterface');
        const closeButton = document.getElementById('closeButton');
        const minimizeButton = document.getElementById('minimizeButton');
        const tooltip = document.getElementById('tooltip');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const chatBody = document.getElementById('chatBody');
        const welcomeSection = document.getElementById('welcomeSection');
        const suggestedActions = document.getElementById('suggestedActions');
        const notificationBadge = document.getElementById('notificationBadge');
        const soundToggle = document.getElementById('soundToggle');
        const attachmentButton = document.getElementById('attachmentButton');
        const emojiPicker = document.getElementById('emojiPicker');
        const agentActionButton = document.getElementById('agentActionButton');
        const agentStatus = document.getElementById('agentStatus');
        const agentDot = document.getElementById('agentDot');
        const agentStatusText = document.getElementById('agentStatusText');

        let isOpen = false;
        let soundEnabled = true;
        let messageCount = 0;
        let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        let currentUser = null;
        let userData = null;
        let registrationStep = 'initial'; // initial, name, email, otp, language, complete
        let agentConnection = null;
        let currentChatId = null;
        let agentListener = null;
        let sessionId = null;
        let isConnectedToAgent = false;
        let chatStartTime = null;
        let messageTimestamps = [];
        let typingTimeout = null;
        let agentsListener = null;

        // Generate unique session ID for device
        function getSessionId() {
            if (!sessionId) {
                sessionId = localStorage.getItem('chat_session_id');
                if (!sessionId) {
                    sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('chat_session_id', sessionId);
                }
            }
            return sessionId;
        }

        // Check if user has active session (12 hours)
        function hasActiveSession() {
            const sessionData = localStorage.getItem('user_session_data');
            if (!sessionData) return false;
            
            try {
                const data = JSON.parse(sessionData);
                const sessionTime = data.timestamp;
                const currentTime = Date.now();
                const twelveHours = 12 * 60 * 60 * 1000; // 12 hours in milliseconds
                
                return (currentTime - sessionTime) < twelveHours;
            } catch (error) {
                return false;
            }
        }

        // Save user session data
        function saveUserSession(userData) {
            const sessionData = {
                ...userData,
                timestamp: Date.now()
            };
            localStorage.setItem('user_session_data', JSON.stringify(sessionData));
        }

        // Get user session data
        function getUserSession() {
            const sessionData = localStorage.getItem('user_session_data');
            if (!sessionData) return null;
            
            try {
                return JSON.parse(sessionData);
            } catch (error) {
                return null;
            }
        }

        // Clear user session
        function clearUserSession() {
            localStorage.removeItem('user_session_data');
        }

        // Create particles
        function createParticles() {
            const particles = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particles.appendChild(particle);
            }
        }

        createParticles();

        // Ripple effect
        function createRipple(e) {
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            chatButton.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        // Play sound
        function playSound(type) {
            if (!soundEnabled) return;
            const audio = new Audio();
            if (type === 'send') {
                audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjGH0fPTgjMGHm7A7+OZSA0PVKzn77BfHAU+ltrywnkrBSl+zPLaizsHGGS57OihUBELTKXh8bllHAY2jdXzzn4vBSh7y/HajDkHF2O36+mjUhELSqPf8bllHAY2jdXzzn4vBSh7y/HajDkHF2O36+mjUhELSqPf8bllHAY2jdXzzn4vBSh7y/HajDkHF2O36+mjUhELSqPf8Q==';
            } else if (type === 'receive') {
                audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjGH0fPTgjMGHm7A7+OZSA0PVKzn77BfHAU+ltrywnkrBSl+zPLaizsHGGS57OihUBELTKXh8bllHAY2jdXzzn4vBSh7y/HajDkHF2O36+mjUhELSqPf8Q==';
            }
            audio.volume = 0.3;
            audio.play().catch(() => {});
        }

        // Handle mobile keyboard - Updated to only trigger on focus
        function handleMobileKeyboard() {
            if (!isMobile) return;
            
            // Only add focus event listener, don't trigger keyboard immediately
            chatInput.addEventListener('focus', () => {
                document.body.classList.add('keyboard-open');
            });
            
            chatInput.addEventListener('blur', () => {
                document.body.classList.remove('keyboard-open');
            });
        }

        // Toggle chat interface
        chatButton.addEventListener('click', (e) => {
            createRipple(e);
            isOpen = !isOpen;
            chatInterface.classList.toggle('open', isOpen);
            tooltip.classList.toggle('show', !isOpen);
            chatButton.classList.toggle('active', isOpen);
            
            if (isOpen) {
                // Don't focus immediately - let user click input when ready
                notificationBadge.style.display = 'none';
                playSound('receive');
                
                // Check if user has active session
                if (hasActiveSession()) {
                    const sessionData = getUserSession();
                    userData = sessionData;
                    currentUser = { uid: getSessionId() }; // Use session ID as user ID for guest users
                    
                    // Hide welcome section and show first message after a delay
                    setTimeout(() => {
                        welcomeSection.style.display = 'none';
                        if (messageCount === 0) {
                            addMessage(`üëã Welcome back ${userData?.name || ''}! How can I help you today?`, 'bot', true);
                            messageCount++;
                        }
                    }, 500);
                } else {
                    // Check if user is registered
                    if (!currentUser) {
                        startRegistrationProcess();
                    } else {
                        // Hide welcome section and show first message after a delay
                        setTimeout(() => {
                            welcomeSection.style.display = 'none';
                            if (messageCount === 0) {
                                addMessage(`üëã Hi there ${userData?.name || ''}! I'm your friendly chat assistant. How can I help you today?`, 'bot', true);
                                messageCount++;
                            }
                        }, 500);
                    }
                }
                
                // Check agent availability
                checkAgentAvailability();
            }
        });

        closeButton.addEventListener('click', () => {
            isOpen = false;
            chatInterface.classList.remove('open');
            tooltip.classList.add('show');
            chatButton.classList.remove('active');
        });

        minimizeButton.addEventListener('click', () => {
            isOpen = false;
            chatInterface.classList.remove('open');
            chatButton.classList.remove('active');
        });

        // Sound toggle
        soundToggle.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            const icon = soundToggle.querySelector('.sound-icon');
            const text = soundToggle.querySelector('span');
            
            if (soundEnabled) {
                text.textContent = '';
                icon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>';
            } else {
                text.textContent = '';
                icon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>';
            }
        });

        // Keyboard support for sound toggle
        soundToggle.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                soundToggle.click();
            }
        });

        // Attachment button
        attachmentButton.addEventListener('click', () => {
            emojiPicker.classList.toggle('show');
        });

        // Emoji picker
        document.querySelectorAll('.emoji').forEach(emoji => {
            emoji.addEventListener('click', () => {
                chatInput.value += emoji.dataset.emoji;
                chatInput.focus();
                emojiPicker.classList.remove('show');
            });
            
            // Keyboard support for emojis
            emoji.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    emoji.click();
                }
            });
        });

        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!attachmentButton.contains(e.target) && !emojiPicker.contains(e.target)) {
                emojiPicker.classList.remove('show');
            }
        });

        // Agent Action Button - Handles both connecting and disconnecting
        agentActionButton.addEventListener('click', handleAgentAction);

        function handleAgentAction() {
            if (isConnectedToAgent) {
                endAgentChat();
            } else {
                connectToAgent();
            }
        }

        // Check agent availability with real-time updates
        function checkAgentAvailability() {
            const agentsRef = ref(rtdb, 'agents/online');
            
            // Remove previous listener if exists
            if (agentsListener) {
                agentsListener();
            }
            
            agentsListener = onValue(agentsRef, (snapshot) => {
                const agents = snapshot.val();
                const onlineAgents = agents ? Object.keys(agents).length : 0;
                
                if (onlineAgents > 0) {
                    agentDot.classList.remove('offline');
                    agentDot.classList.add('online');
                    agentStatusText.textContent = `${onlineAgents} agents online`;
                    agentActionButton.disabled = false;
                    agentActionButton.style.display = 'flex';
                } else {
                    agentDot.classList.remove('online');
                    agentDot.classList.add('offline');
                    agentStatusText.textContent = 'No agents available';
                    agentActionButton.disabled = true;
                    agentActionButton.style.display = 'flex';
                }
            });
        }

        // Connect to agent
        async function connectToAgent() {
            if (!userData) {
                alert('Please complete registration first');
                return;
            }
            
            agentActionButton.disabled = true;
            agentActionButton.innerHTML = `
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                Connecting...
            `;
            
            try {
                // Create a new chat session using RTDB
                const chatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                currentChatId = chatId;
                
                // Create chat in RTDB
                await set(ref(rtdb, `chats/${chatId}`), {
                    userId: currentUser.uid,
                    userName: userData.name,
                    userEmail: userData.email,
                    sessionId: getSessionId(),
                    status: 'waiting',
                    createdAt: Date.now(),
                    initialMessage: 'Customer requested to speak with an agent'
                });
                
                // Listen for agent responses
                listenForAgentMessages();
                
                // Update UI
                welcomeSection.style.display = 'none';
                suggestedActions.style.display = 'none';
                
                addMessage("üîÑ Connecting you to an agent. Please wait...", 'bot');
                
                // Check for agent assignment every 5 seconds
                const checkInterval = setInterval(async () => {
                    const chatRef = ref(rtdb, `chats/${chatId}`);
                    const chatSnapshot = await get(chatRef);
                    
                    if (chatSnapshot.exists()) {
                        const chatData = chatSnapshot.val();
                        if (chatData.agentId) {
                            clearInterval(checkInterval);
                            agentConnection = chatData.agentId;
                            isConnectedToAgent = true;
                            chatStartTime = Date.now();
                            messageTimestamps = [];
                            
                            // Update button to show End Chat
                            agentActionButton.disabled = false;
                            agentActionButton.innerHTML = `
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.67-1.85.99.99 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
                                </svg>
                                End Chat
                            `;
                            agentActionButton.classList.remove('agent-button');
                            agentActionButton.classList.add('end-chat-button');
                            
                            addMessage("‚úÖ You're now connected to an agent! How can we help you?", 'bot');
                            
                            // Update agent status
                            agentStatusText.textContent = 'Connected to agent';
                            
                            // Start chat metrics update
                            updateChatMetrics();
                        }
                    }
                }, 5000);
                
                // Timeout after 60 seconds
                setTimeout(() => {
                    clearInterval(checkInterval);
                    if (!agentConnection) {
                        addMessage("‚ùå Sorry, no agents are available right now. Please try again later or continue chatting with me.", 'bot');
                        agentActionButton.disabled = false;
                        agentActionButton.innerHTML = `
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            Speak to Agent
                        `;
                        agentActionButton.classList.add('agent-button');
                        agentActionButton.classList.remove('end-chat-button');
                        
                        // Remove the waiting chat if no agent connected
                        remove(ref(rtdb, `chats/${chatId}`));
                        currentChatId = null;
                    }
                }, 60000);
                
            } catch (error) {
                console.error('Error connecting to agent:', error);
                addMessage("‚ùå Sorry, there was an error connecting to an agent. Please try again.", 'bot');
                agentActionButton.disabled = false;
                agentActionButton.innerHTML = `
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Speak to Agent
                `;
                agentActionButton.classList.add('agent-button');
                agentActionButton.classList.remove('end-chat-button');
            }
        }

        // Listen for agent messages
        function listenForAgentMessages() {
            if (!currentChatId) return;
            
            const messagesRef = ref(rtdb, `chats/${currentChatId}/messages`);
            
            // Remove previous listener if exists
            if (agentListener) {
                agentListener();
            }
            
            agentListener = onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val();
                if (messages) {
                    Object.values(messages).forEach(message => {
                        if (message.sender === 'agent' && !message.displayed) {
                            addMessage(message.content, 'bot');
                            playSound('receive');
                            
                            // Track agent response times
                            messageTimestamps.push(Date.now());
                            updateChatMetrics();
                            
                            // Mark message as displayed
                            const messageKey = Object.keys(messages).find(key => messages[key] === message);
                            if (messageKey) {
                                update(ref(rtdb, `chats/${currentChatId}/messages/${messageKey}`), {
                                    displayed: true
                                });
                            }
                        }
                    });
                }
            });
        }

        // Send message to agent
        async function sendMessageToAgent(text) {
            if (!currentChatId || !agentConnection) {
                addMessage("You're not currently connected to an agent.", 'bot');
                return;
            }
            
            try {
                // Add message to RTDB
                const messagesRef = ref(rtdb, `chats/${currentChatId}/messages`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, {
                    sender: 'user',
                    content: text,
                    timestamp: Date.now(),
                    status: 'sent'
                });
                
                // Update last message in chat
                await update(ref(rtdb, `chats/${currentChatId}`), {
                    lastMessage: text,
                    lastMessageTime: Date.now(),
                    status: 'active'
                });
                
                // Track user message times
                messageTimestamps.push(Date.now());
                updateChatMetrics();
            } catch (error) {
                console.error('Error sending message to agent:', error);
                addMessage("‚ùå Failed to send message to agent. Please try again.", 'bot');
            }
        }

        // End agent chat
        async function endAgentChat() {
            if (!currentChatId) return;
            
            try {
                // Update chat status in RTDB
                await update(ref(rtdb, `chats/${currentChatId}`), {
                    status: 'ended',
                    endedAt: Date.now(),
                    endedBy: 'user'
                });
                
                // Add system message
                const messagesRef = ref(rtdb, `chats/${currentChatId}/messages`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, {
                    sender: 'system',
                    content: 'Chat ended by customer.',
                    timestamp: Date.now()
                });
                
                // Clean up
                if (agentListener) {
                    agentListener();
                }
                
                agentConnection = null;
                currentChatId = null;
                isConnectedToAgent = false;
                chatStartTime = null;
                messageTimestamps = [];
                
                // Update UI
                addMessage("You've ended the chat with the agent. How can I help you?", 'bot');
                agentStatusText.textContent = 'Agents online';
                
                // Reset button to Speak to Agent
                agentActionButton.disabled = false;
                agentActionButton.innerHTML = `
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Speak to Agent
                `;
                agentActionButton.classList.add('agent-button');
                agentActionButton.classList.remove('end-chat-button');
                
                // Check agent availability again
                checkAgentAvailability();
                
            } catch (error) {
                console.error('Error ending agent chat:', error);
            }
        }

        // Update chat metrics
        function updateChatMetrics() {
            if (!chatStartTime) return;
            
            // Update duration
            const duration = Date.now() - chatStartTime;
            // In a real implementation, you would display this in the UI
            console.log(`Chat duration: ${formatDuration(duration)}`);
            
            // Update average response time
            if (messageTimestamps.length > 1) {
                let totalResponseTime = 0;
                for (let i = 1; i < messageTimestamps.length; i++) {
                    totalResponseTime += messageTimestamps[i] - messageTimestamps[i-1];
                }
                const avgResponseTime = totalResponseTime / (messageTimestamps.length - 1);
                console.log(`Average response time: ${Math.round(avgResponseTime / 1000)}s`);
            }
        }

        // Format duration
        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m`;
            } else {
                return `${seconds}s`;
            }
        }

        // Registration Process
        function startRegistrationProcess() {
            // Clear chat body
            chatBody.innerHTML = '';
            welcomeSection.style.display = 'none';
            suggestedActions.style.display = 'none';
            
            // Show initial registration message
            addMessage("üëã Welcome! To provide you with the best experience, we'd like to get to know you better. Let's start with your name.", 'bot');
            
            // Show name input form
            showNameForm();
        }

        function showNameForm() {
            registrationStep = 'name';
            
            const nameForm = document.createElement('div');
            nameForm.className = 'registration-form';
            nameForm.innerHTML = `
                <div class="form-title">What's your name?</div>
                <div class="form-group">
                    <input type="text" class="form-input" id="nameInput" placeholder="Enter your full name" autocomplete="name">
                </div>
                <button class="form-button" id="nameSubmit">Continue</button>
            `;
            
            chatBody.appendChild(nameForm);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // Focus on name input
            setTimeout(() => {
                const nameInput = document.getElementById('nameInput');
                if (nameInput) nameInput.focus();
            }, 100);
            
            // Add event listener for name submission
            document.getElementById('nameSubmit').addEventListener('click', submitName);
            
            // Allow Enter key to submit
            document.getElementById('nameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitName();
                }
            });
        }

        function submitName() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                showError('Please enter your name');
                return;
            }
            
            // Store name temporarily
            userData = { name };
            
            // Remove name form
            const nameForm = document.querySelector('.registration-form');
            if (nameForm) nameForm.remove();
            
            // Show email form
            showEmailForm();
        }

        function showEmailForm() {
            registrationStep = 'email';
            
            addMessage(`Nice to meet you, ${userData.name}! What's your email address?`, 'bot');
            
            const emailForm = document.createElement('div');
            emailForm.className = 'registration-form';
            emailForm.innerHTML = `
                <div class="form-title">Enter your email</div>
                <div class="form-group">
                    <input type="email" class="form-input" id="emailInput" placeholder="your.email@example.com" autocomplete="email">
                </div>
                <button class="form-button" id="emailSubmit">Send Verification Code</button>
                <div class="form-note">We'll send a verification code to this email</div>
                <div class="error-message" id="emailError"></div>
            `;
            
            chatBody.appendChild(emailForm);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // Focus on email input
            setTimeout(() => {
                const emailInput = document.getElementById('emailInput');
                if (emailInput) emailInput.focus();
            }, 100);
            
            // Add event listener for email submission
            document.getElementById('emailSubmit').addEventListener('click', submitEmail);
            
            // Allow Enter key to submit
            document.getElementById('emailInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitEmail();
                }
            });
        }

        async function submitEmail() {
            const emailInput = document.getElementById('emailInput');
            const email = emailInput.value.trim();
            const errorDiv = document.getElementById('emailError');
            
            if (!email || !isValidEmail(email)) {
                showError('Please enter a valid email address', errorDiv);
                return;
            }
            
            // Store email temporarily
            userData.email = email;
            
            // Show loading state
            const submitButton = document.getElementById('emailSubmit');
            submitButton.disabled = true;
            submitButton.textContent = 'Sending...';
            hideError(errorDiv);
            
            try {
                // Store email in RTDB for OTP verification
                const emailRef = ref(rtdb, `pendingRegistrations/${email.replace(/\./g, '_')}`);
                await set(emailRef, {
                    name: userData.name,
                    email: userData.email,
                    createdAt: Date.now(),
                    sessionId: getSessionId()
                });
                
                // For demo purposes, we'll simulate OTP sending
                // In a real app, you would call a Firebase function to send OTP
                const otp = Math.floor(100000 + Math.random() * 900000).toString();
                const otpRef = ref(rtdb, `otps/${email.replace(/\./g, '_')}`);
                await set(otpRef, {
                    otp: otp,
                    timestamp: Date.now(),
                    attempts: 0
                });
                
                console.log(`Demo OTP for ${email}: ${otp}`); // For testing
                
                // Remove email form
                const emailForm = document.querySelector('.registration-form');
                if (emailForm) emailForm.remove();
                
                // Show OTP form
                showOTPForm();
                
            } catch (error) {
                console.error('Error sending OTP:', error);
                showError('Failed to send verification code. Please try again.', errorDiv);
                submitButton.disabled = false;
                submitButton.textContent = 'Send Verification Code';
            }
        }

        function showOTPForm() {
            registrationStep = 'otp';
            
            addMessage(`We've sent a 6-digit verification code to ${userData.email}. Please enter it below.`, 'bot');
            
            const otpForm = document.createElement('div');
            otpForm.className = 'registration-form';
            otpForm.innerHTML = `
                <div class="form-title">Enter Verification Code</div>
                <div class="otp-input">
                    <input type="text" class="otp-digit" maxlength="1" id="otp1">
                    <input type="text" class="otp-digit" maxlength="1" id="otp2">
                    <input type="text" class="otp-digit" maxlength="1" id="otp3">
                    <input type="text" class="otp-digit" maxlength="1" id="otp4">
                    <input type="text" class="otp-digit" maxlength="1" id="otp5">
                    <input type="text" class="otp-digit" maxlength="1" id="otp6">
                </div>
                <button class="form-button" id="otpSubmit">Verify & Continue</button>
                <div class="resend-otp" id="resendOTP">Didn't receive the code? Resend</div>
                <div class="error-message" id="otpError"></div>
            `;
            
            chatBody.appendChild(otpForm);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // Focus on first OTP input
            setTimeout(() => {
                const otp1 = document.getElementById('otp1');
                if (otp1) otp1.focus();
            }, 100);
            
            // Add event listeners for OTP inputs
            setupOTPInputs();
            
            // Add event listener for OTP submission
            document.getElementById('otpSubmit').addEventListener('click', submitOTP);
            
            // Add event listener for resend OTP
            document.getElementById('resendOTP').addEventListener('click', resendOTP);
        }

        function setupOTPInputs() {
            const otpInputs = document.querySelectorAll('.otp-digit');
            
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1) {
                        if (index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });
        }

        async function submitOTP() {
            const otp1 = document.getElementById('otp1').value;
            const otp2 = document.getElementById('otp2').value;
            const otp3 = document.getElementById('otp3').value;
            const otp4 = document.getElementById('otp4').value;
            const otp5 = document.getElementById('otp5').value;
            const otp6 = document.getElementById('otp6').value;
            const errorDiv = document.getElementById('otpError');
            
            const otp = otp1 + otp2 + otp3 + otp4 + otp5 + otp6;
            
            if (otp.length !== 6) {
                showError('Please enter the complete 6-digit code', errorDiv);
                return;
            }
            
            // Show loading state
            const submitButton = document.getElementById('otpSubmit');
            submitButton.disabled = true;
            submitButton.textContent = 'Verifying...';
            hideError(errorDiv);
            
            try {
                // Check OTP in RTDB
                const otpRef = ref(rtdb, `otps/${userData.email.replace(/\./g, '_')}`);
                const otpSnapshot = await get(otpRef);
                
                if (!otpSnapshot.exists()) {
                    throw new Error('OTP not found or expired');
                }
                
                const otpData = otpSnapshot.val();
                
                // Check if OTP is expired (10 minutes)
                if (Date.now() - otpData.timestamp > 10 * 60 * 1000) {
                    await remove(otpRef);
                    throw new Error('OTP expired');
                }
                
                // Check if too many attempts
                if (otpData.attempts >= 5) {
                    await remove(otpRef);
                    throw new Error('Too many attempts');
                }
                
                // Verify OTP
                if (otpData.otp === otp) {
                    // OTP is correct, remove it from RTDB
                    await remove(otpRef);
                    
                    // Remove OTP form
                    const otpForm = document.querySelector('.registration-form');
                    if (otpForm) otpForm.remove();
                    
                    // Save user session for 12 hours
                    saveUserSession(userData);
                    
                    // Set current user with session ID
                    currentUser = { uid: getSessionId() };
                    
                    // Show language selection
                    showLanguageSelection();
                } else {
                    // OTP is incorrect, increment attempts
                    await update(otpRef, {
                        attempts: otpData.attempts + 1
                    });
                    
                    throw new Error('Invalid verification code');
                }
            } catch (error) {
                console.error('Error verifying OTP:', error);
                showError(error.message, errorDiv);
                submitButton.disabled = false;
                submitButton.textContent = 'Verify & Continue';
            }
        }

        async function resendOTP() {
            const resendButton = document.getElementById('resendOTP');
            const errorDiv = document.getElementById('otpError');
            
            resendButton.disabled = true;
            resendButton.textContent = 'Resending...';
            hideError(errorDiv);
            
            try {
                // For demo purposes, generate a new OTP
                const otp = Math.floor(100000 + Math.random() * 900000).toString();
                const otpRef = ref(rtdb, `otps/${userData.email.replace(/\./g, '_')}`);
                await set(otpRef, {
                    otp: otp,
                    timestamp: Date.now(),
                    attempts: 0
                });
                
                console.log(`New demo OTP for ${userData.email}: ${otp}`); // For testing
                
                showSuccess('Verification code has been resent to your email.', errorDiv);
                
                // Re-enable button after 30 seconds
                setTimeout(() => {
                    resendButton.disabled = false;
                    resendButton.textContent = 'Didn\'t receive the code? Resend';
                }, 30000);
                
            } catch (error) {
                console.error('Error resending OTP:', error);
                showError('Failed to resend verification code. Please try again.', errorDiv);
                resendButton.disabled = false;
                resendButton.textContent = 'Didn\'t receive the code? Resend';
            }
        }

        function showLanguageSelection() {
            registrationStep = 'language';
            
            addMessage('Great! Your email has been verified. Please select your preferred language.', 'bot');
            
            const languageForm = document.createElement('div');
            languageForm.className = 'registration-form';
            languageForm.innerHTML = `
                <div class="form-title">Select Language</div>
                <div class="language-selection">
                    <div class="language-option" data-lang="en">English</div>
                    <div class="language-option" data-lang="es">Espa√±ol</div>
                    <div class="language-option" data-lang="fr">Fran√ßais</div>
                    <div class="language-option" data-lang="de">Deutsch</div>
                    <div class="language-option" data-lang="it">Italiano</div>
                    <div class="language-option" data-lang="pt">Portugu√™s</div>
                    <div class="language-option" data-lang="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
                    <div class="language-option" data-lang="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</div>
                </div>
                <button class="form-button" id="languageSubmit">Continue</button>
                <div class="error-message" id="languageError"></div>
            `;
            
            chatBody.appendChild(languageForm);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // Add event listeners for language selection
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected class from all options
                    document.querySelectorAll('.language-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    option.classList.add('selected');
                    
                    // Store selected language
                    userData.language = option.getAttribute('data-lang');
                });
            });
            
            // Add event listener for language submission
            document.getElementById('languageSubmit').addEventListener('click', submitLanguage);
        }

        async function submitLanguage() {
            const errorDiv = document.getElementById('languageError');
            
            if (!userData.language) {
                showError('Please select a language', errorDiv);
                return;
            }
            
            // Show loading state
            const submitButton = document.getElementById('languageSubmit');
            submitButton.disabled = true;
            submitButton.textContent = 'Setting up...';
            hideError(errorDiv);
            
            try {
                // Save user data to RTDB
                const userRef = ref(rtdb, `users/${userData.email.replace(/\./g, '_')}`);
                await set(userRef, {
                    name: userData.name,
                    email: userData.email,
                    language: userData.language,
                    createdAt: Date.now(),
                    lastActive: Date.now()
                });
                
                // Update user data with language
                userData.language = userData.language;
                saveUserSession(userData);
                
                // Registration complete
                registrationStep = 'complete';
                
                // Remove language form
                const languageForm = document.querySelector('.registration-form');
                if (languageForm) languageForm.remove();
                
                // Show welcome message
                addMessage(`üéâ Registration complete! Welcome to our chat service, ${userData.name}. How can I help you today?`, 'bot', true);
                
                // Show suggested actions
                suggestedActions.style.display = 'block';
                
                // Show agent action button
                agentActionButton.style.display = 'flex';
                
                // Check agent availability
                checkAgentAvailability();
                
            } catch (error) {
                console.error('Error updating language:', error);
                showError('Failed to save language preference. Please try again.', errorDiv);
                submitButton.disabled = false;
                submitButton.textContent = 'Continue';
            }
        }

        // Utility functions
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showError(message, errorDiv) {
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            } else {
                alert(message);
            }
        }

        function showSuccess(message, successDiv) {
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                successDiv.className = 'success-message';
            }
        }

        function hideError(errorDiv) {
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        // Updated sendMessage function
        async function sendMessage(text) {
            if (!text.trim()) return;

            playSound('send');
            addMessage(text, 'user');
            chatInput.value = '';
            suggestedActions.style.display = 'none';

            // If connected to agent, send to agent instead
            if (agentConnection) {
                sendMessageToAgent(text);
                return;
            }

            // Show typing indicator
            showTypingIndicator();

            try {
                // For demo purposes, use a simple response
                // In a real app, you would call Gemini API or similar
                const responses = [
                    "Thanks for your message! I'm here to help with any questions you have. üòä",
                    "I understand your question. Let me provide you with more information about that.",
                    "That's a great question! Our team can help you with that.",
                    "I appreciate you reaching out. Let me connect you with the right resources."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                
                setTimeout(() => {
                    hideTypingIndicator();
                    playSound('receive');
                    addMessage(randomResponse, 'bot', true);
                }, 1500);
                
            } catch (error) {
                console.error('Error getting response:', error);
                hideTypingIndicator();
                playSound('receive');
                
                // Fallback responses in different languages
                const fallbackResponses = {
                    en: "Thanks for your message! I'm here to help with any questions about our services. üòä",
                    es: "¬°Gracias por tu mensaje! Estoy aqu√≠ para ayudar con cualquier pregunta sobre nuestros servicios. üòä",
                    fr: "Merci pour votre message ! Je suis l√† pour aider avec toutes les questions concernant nos services. üòä",
                    de: "Vielen Dank f√ºr Ihre Nachricht! Ich bin hier, um bei Fragen zu unseren Dienstleistungen zu helfen. üòä",
                    it: "Grazie per il tuo messaggio! Sono qui per aiutarti con qualsiasi domanda sui nostri servizi. üòä",
                    pt: "Obrigado pela sua mensagem! Estou aqui para ajudar com qualquer d√∫vida sobre nossos servi√ßos. üòä",
                    ar: "ÿ¥ŸÉÿ±Ÿãÿß ÿπŸÑŸâ ÿ±ÿ≥ÿßŸÑÿ™ŸÉ! ÿ£ŸÜÿß ŸáŸÜÿß ŸÑŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸä ÿ£Ÿä ÿ£ÿ≥ÿ¶ŸÑÿ© ÿ≠ŸàŸÑ ÿÆÿØŸÖÿßÿ™ŸÜÿß. üòä",
                    hi: "‡§Ü‡§™‡§ï‡•á ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§Æ‡•à‡§Ç ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§∏‡•á‡§µ‡§æ‡§ì‡§Ç ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Ç ‡§π‡•Ç‡§Ç‡•§ üòä"
                };
                
                const userLanguage = userData?.language || 'en';
                const fallbackResponse = fallbackResponses[userLanguage] || fallbackResponses.en;
                addMessage(fallbackResponse, 'bot', true);
            }
        }

        // Add message to chat
        function addMessage(text, sender, showQuickReplies = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const status = sender === 'user' ? '<div class="message-status sent">Sent</div>' : '';
            
            if (sender === 'bot') {
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                            <circle cx="9" cy="10" r="1.5"/>
                            <circle cx="15" cy="10" r="1.5"/>
                            <path d="M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="message-content">${text}</div>
                        <div class="message-time">${time}</div>
                        ${showQuickReplies ? `
                            <div class="quick-replies">
                                <button class="quick-reply" data-reply="I need help with pricing">üí∞ Pricing</button>
                                <button class="quick-reply" data-reply="Tell me more about your services">‚ÑπÔ∏è Services</button>
                                <button class="quick-reply" data-reply="I want to schedule a demo">üìÖ Schedule Demo</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">U</div>
                    <div>
                        <div class="message-content">${text}</div>
                        <div class="message-time">${time}</div>
                        ${status}
                    </div>
                `;
            }
            
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // Add focus management for new quick replies
            if (showQuickReplies) {
                setTimeout(() => {
                    const quickReplies = messageDiv.querySelectorAll('.quick-reply');
                    quickReplies.forEach((reply, index) => {
                        reply.setAttribute('tabindex', '0');
                    });
                }, 100);
            }
        }

        // Typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                        <circle cx="9" cy="10" r="1.5"/>
                        <circle cx="15" cy="10" r="1.5"/>
                        <path d="M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                    </svg>
                </div>
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatBody.appendChild(typingDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Event listeners
        sendButton.addEventListener('click', () => {
            if (registrationStep === 'complete' || !currentUser) {
                sendMessage(chatInput.value);
            }
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && (registrationStep === 'complete' || !currentUser)) {
                sendMessage(chatInput.value);
            }
        });

        // Quick replies
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('quick-reply')) {
                const reply = e.target.getAttribute('data-reply');
                sendMessage(reply);
            }
        });

        // Keyboard support for quick replies
        document.addEventListener('keydown', (e) => {
            if (e.target.classList.contains('quick-reply') && (e.key === 'Enter' || e.key === ' ')) {
                e.preventDefault();
                const reply = e.target.getAttribute('data-reply');
                sendMessage(reply);
            }
        });

        // Action buttons
        document.querySelectorAll('.action-button').forEach(button => {
            button.addEventListener('click', () => {
                const action = button.getAttribute('data-action');
                let message = '';
                
                switch(action) {
                    case 'pricing':
                        message = 'I would like to know about your pricing';
                        break;
                    case 'support':
                        message = 'I need support with my account';
                        break;
                    case 'demo':
                        message = 'I want to watch a product demo';
                        break;
                    case 'contact':
                        message = 'I would like to contact your team';
                        break;
                }
                
                sendMessage(message);
            });
            
            // Keyboard support for action buttons
            button.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    button.click();
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape key to close chat
            if (e.key === 'Escape' && isOpen) {
                isOpen = false;
                chatInterface.classList.remove('open');
                tooltip.classList.add('show');
                chatButton.classList.remove('active');
            }
            
            // Ctrl/Cmd + K to open chat
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                if (!isOpen) {
                    chatButton.click();
                }
            }
        });

        // Show notification badge after 3 seconds if chat is closed
        setTimeout(() => {
            if (!isOpen) {
                notificationBadge.style.display = 'flex';
            }
        }, 3000);

        // Hide tooltip after 5 seconds
        setTimeout(() => {
            if (!isOpen) {
                tooltip.classList.remove('show');
            }
        }, 5000);

        // Bring back tooltip on hover
        chatButton.addEventListener('mouseenter', () => {
            if (!isOpen) {
                tooltip.classList.add('show');
            }
        });

        chatButton.addEventListener('mouseleave', () => {
            setTimeout(() => {
                if (!isOpen) {
                    tooltip.classList.remove('show');
                    }
            }, 2000);
        });

        // Initialize mobile keyboard handling - keyboard will only appear when input is focused
        handleMobileKeyboard();

        // Initialize session ID
        getSessionId();

        // Check if user has active session on page load
        if (hasActiveSession()) {
            const sessionData = getUserSession();
            userData = sessionData;
            currentUser = { uid: getSessionId() };
            registrationStep = 'complete';
            
            // Show agent button if chat is open
            if (isOpen) {
                agentActionButton.style.display = 'flex';
                checkAgentAvailability();
            }
        }
    </script>
</body>
</html>